name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (for example v0.1.0)"
        required: true
        type: string

concurrency:
  group: release-${{ github.ref_name || github.event.inputs.tag }}
  cancel-in-progress: false

jobs:
  release-dmg:
    runs-on: macos-26
    permissions:
      contents: write
    steps:
      - name: Resolve release metadata
        id: meta
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
        run: |
          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            TAG="${INPUT_TAG}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi

          if [[ ! "${TAG}" =~ ^v[0-9] ]]; then
            echo "::error::Tag must start with v (for example v0.1.0)."
            exit 1
          fi

          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.meta.outputs.tag }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: sidecar/package-lock.json

      - name: Validate release secrets
        env:
          APPLE_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_PRIVATE_KEY_BASE64: ${{ secrets.APPLE_API_PRIVATE_KEY_BASE64 }}
        run: |
          for required in \
            APPLE_CERTIFICATE_P12_BASE64 \
            APPLE_CERTIFICATE_PASSWORD \
            APPLE_API_KEY_ID \
            APPLE_API_ISSUER_ID \
            APPLE_API_PRIVATE_KEY_BASE64
          do
            if [ -z "${!required}" ]; then
              echo "::error::Missing secret: ${required}"
              exit 1
            fi
          done

      - uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Resolve signing identity
        id: signing
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          IDENTITY="${APPLE_SIGNING_IDENTITY}"
          if [ -z "${IDENTITY}" ]; then
            IDENTITY="$(security find-identity -v -p codesigning | awk -F'"' '/Developer ID Application:/{print $2; exit}')"
          fi

          if [ -z "${IDENTITY}" ]; then
            echo "::error::No Developer ID Application identity found."
            exit 1
          fi

          echo "identity=${IDENTITY}" >> "${GITHUB_OUTPUT}"
          echo "Using signing identity: ${IDENTITY}"

      - name: Build and sign Flux.app
        env:
          SIGNING_IDENTITY: ${{ steps.signing.outputs.identity }}
        run: |
          swift --version
          swift build -c release --package-path Flux --arch arm64
          BIN_PATH="$(swift build -c release --package-path Flux --arch arm64 --show-bin-path)"

          APP_BUNDLE="${RUNNER_TEMP}/Flux.app"
          mkdir -p "${APP_BUNDLE}/Contents/MacOS"
          mkdir -p "${APP_BUNDLE}/Contents/Resources"
          cp "${BIN_PATH}/Flux" "${APP_BUNDLE}/Contents/MacOS/Flux"
          cp "Flux/Info.plist" "${APP_BUNDLE}/Contents/Info.plist"

          if [ -d ".agents/skills" ]; then
            mkdir -p "${APP_BUNDLE}/Contents/Resources/agents"
            cp -R ".agents/skills" "${APP_BUNDLE}/Contents/Resources/agents/skills"
          fi

          chmod +x "${APP_BUNDLE}/Contents/MacOS/Flux"
          codesign \
            --force \
            --deep \
            --options runtime \
            --timestamp \
            --sign "${SIGNING_IDENTITY}" \
            "${APP_BUNDLE}"
          codesign --verify --deep --strict --verbose=2 "${APP_BUNDLE}"

      - name: Build sidecar distribution bundle
        run: |
          npm ci --prefix sidecar
          npm run build --prefix sidecar
          tar -czf "${RUNNER_TEMP}/sidecar-dist.tgz" \
            -C sidecar \
            dist \
            package.json \
            package-lock.json

      - name: Create, notarize, and staple DMG
        id: dmg
        env:
          SIGNING_IDENTITY: ${{ steps.signing.outputs.identity }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_PRIVATE_KEY_BASE64: ${{ secrets.APPLE_API_PRIVATE_KEY_BASE64 }}
        run: |
          DMG_NAME="flux-${{ steps.meta.outputs.version }}.dmg"
          DMG_PATH="${RUNNER_TEMP}/${DMG_NAME}"
          APP_BUNDLE="${RUNNER_TEMP}/Flux.app"

          hdiutil create \
            -volname "Flux" \
            -srcfolder "${APP_BUNDLE}" \
            -ov \
            -format UDZO \
            "${DMG_PATH}"

          codesign --force --timestamp --sign "${SIGNING_IDENTITY}" "${DMG_PATH}"
          codesign --verify --verbose=2 "${DMG_PATH}"

          KEY_PATH="${RUNNER_TEMP}/AuthKey_${APPLE_API_KEY_ID}.p8"
          if ! printf '%s' "${APPLE_API_PRIVATE_KEY_BASE64}" | base64 --decode > "${KEY_PATH}" 2>/dev/null; then
            printf '%s' "${APPLE_API_PRIVATE_KEY_BASE64}" | base64 -D > "${KEY_PATH}"
          fi

          xcrun notarytool submit "${DMG_PATH}" \
            --key "${KEY_PATH}" \
            --key-id "${APPLE_API_KEY_ID}" \
            --issuer "${APPLE_API_ISSUER_ID}" \
            --wait

          xcrun stapler staple "${DMG_PATH}"
          xcrun stapler validate "${DMG_PATH}"
          spctl --assess --type open --context context:primary-signature --verbose=2 "${DMG_PATH}"

          CHECKSUM_PATH="${RUNNER_TEMP}/${DMG_NAME}.sha256"
          (
            cd "${RUNNER_TEMP}"
            shasum -a 256 "${DMG_NAME}" > "${DMG_NAME}.sha256"
          )
          echo "name=${DMG_NAME}" >> "${GITHUB_OUTPUT}"
          echo "path=${DMG_PATH}" >> "${GITHUB_OUTPUT}"
          echo "checksum_path=${CHECKSUM_PATH}" >> "${GITHUB_OUTPUT}"
          echo "sidecar_path=${RUNNER_TEMP}/sidecar-dist.tgz" >> "${GITHUB_OUTPUT}"

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flux-dmg-${{ steps.meta.outputs.version }}
          path: |
            ${{ steps.dmg.outputs.path }}
            ${{ steps.dmg.outputs.checksum_path }}
            ${{ steps.dmg.outputs.sidecar_path }}

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          fail_on_unmatched_files: true
          generate_release_notes: true
          files: |
            ${{ steps.dmg.outputs.path }}
            ${{ steps.dmg.outputs.checksum_path }}
            ${{ steps.dmg.outputs.sidecar_path }}
